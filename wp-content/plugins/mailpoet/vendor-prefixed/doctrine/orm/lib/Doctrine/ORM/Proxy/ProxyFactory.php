<?php
 namespace MailPoetVendor\Doctrine\ORM\Proxy; if (!defined('ABSPATH')) exit; use MailPoetVendor\Doctrine\Common\Persistence\Mapping\ClassMetadata; use MailPoetVendor\Doctrine\Common\Proxy\AbstractProxyFactory; use MailPoetVendor\Doctrine\Common\Proxy\Proxy as BaseProxy; use MailPoetVendor\Doctrine\Common\Proxy\ProxyDefinition; use MailPoetVendor\Doctrine\Common\Proxy\ProxyGenerator; use MailPoetVendor\Doctrine\Common\Util\ClassUtils; use MailPoetVendor\Doctrine\ORM\EntityManagerInterface; use MailPoetVendor\Doctrine\ORM\Persisters\Entity\EntityPersister; use MailPoetVendor\Doctrine\ORM\EntityNotFoundException; use MailPoetVendor\Doctrine\ORM\Utility\IdentifierFlattener; class ProxyFactory extends \MailPoetVendor\Doctrine\Common\Proxy\AbstractProxyFactory { private $em; private $uow; private $proxyNs; private $identifierFlattener; public function __construct(\MailPoetVendor\Doctrine\ORM\EntityManagerInterface $em, $proxyDir, $proxyNs, $autoGenerate = \MailPoetVendor\Doctrine\Common\Proxy\AbstractProxyFactory::AUTOGENERATE_NEVER) { $proxyGenerator = new \MailPoetVendor\Doctrine\Common\Proxy\ProxyGenerator($proxyDir, $proxyNs); $proxyGenerator->setPlaceholder('baseProxyInterface', 'MailPoetVendor\\Doctrine\\ORM\\Proxy\\Proxy'); parent::__construct($proxyGenerator, $em->getMetadataFactory(), $autoGenerate); $this->em = $em; $this->uow = $em->getUnitOfWork(); $this->proxyNs = $proxyNs; $this->identifierFlattener = new \MailPoetVendor\Doctrine\ORM\Utility\IdentifierFlattener($this->uow, $em->getMetadataFactory()); } protected function skipClass(\MailPoetVendor\Doctrine\Common\Persistence\Mapping\ClassMetadata $metadata) { return $metadata->isMappedSuperclass || $metadata->isEmbeddedClass || $metadata->getReflectionClass()->isAbstract(); } protected function createProxyDefinition($className) { $classMetadata = $this->em->getClassMetadata($className); $entityPersister = $this->uow->getEntityPersister($className); return new \MailPoetVendor\Doctrine\Common\Proxy\ProxyDefinition(\MailPoetVendor\Doctrine\Common\Util\ClassUtils::generateProxyClassName($className, $this->proxyNs), $classMetadata->getIdentifierFieldNames(), $classMetadata->getReflectionProperties(), $this->createInitializer($classMetadata, $entityPersister), $this->createCloner($classMetadata, $entityPersister)); } private function createInitializer(\MailPoetVendor\Doctrine\Common\Persistence\Mapping\ClassMetadata $classMetadata, \MailPoetVendor\Doctrine\ORM\Persisters\Entity\EntityPersister $entityPersister) { if ($classMetadata->getReflectionClass()->hasMethod('__wakeup')) { return function (\MailPoetVendor\Doctrine\Common\Proxy\Proxy $proxy) use($entityPersister, $classMetadata) { $initializer = $proxy->__getInitializer(); $cloner = $proxy->__getCloner(); $proxy->__setInitializer(null); $proxy->__setCloner(null); if ($proxy->__isInitialized()) { return; } $properties = $proxy->__getLazyProperties(); foreach ($properties as $propertyName => $property) { if (!isset($proxy->{$propertyName})) { $proxy->{$propertyName} = $properties[$propertyName]; } } $proxy->__setInitialized(\true); $proxy->__wakeup(); $identifier = $classMetadata->getIdentifierValues($proxy); if (null === $entityPersister->loadById($identifier, $proxy)) { $proxy->__setInitializer($initializer); $proxy->__setCloner($cloner); $proxy->__setInitialized(\false); throw \MailPoetVendor\Doctrine\ORM\EntityNotFoundException::fromClassNameAndIdentifier($classMetadata->getName(), $this->identifierFlattener->flattenIdentifier($classMetadata, $identifier)); } }; } return function (\MailPoetVendor\Doctrine\Common\Proxy\Proxy $proxy) use($entityPersister, $classMetadata) { $initializer = $proxy->__getInitializer(); $cloner = $proxy->__getCloner(); $proxy->__setInitializer(null); $proxy->__setCloner(null); if ($proxy->__isInitialized()) { return; } $properties = $proxy->__getLazyProperties(); foreach ($properties as $propertyName => $property) { if (!isset($proxy->{$propertyName})) { $proxy->{$propertyName} = $properties[$propertyName]; } } $proxy->__setInitialized(\true); $identifier = $classMetadata->getIdentifierValues($proxy); if (null === $entityPersister->loadById($identifier, $proxy)) { $proxy->__setInitializer($initializer); $proxy->__setCloner($cloner); $proxy->__setInitialized(\false); throw \MailPoetVendor\Doctrine\ORM\EntityNotFoundException::fromClassNameAndIdentifier($classMetadata->getName(), $this->identifierFlattener->flattenIdentifier($classMetadata, $identifier)); } }; } private function createCloner(\MailPoetVendor\Doctrine\Common\Persistence\Mapping\ClassMetadata $classMetadata, \MailPoetVendor\Doctrine\ORM\Persisters\Entity\EntityPersister $entityPersister) { return function (\MailPoetVendor\Doctrine\Common\Proxy\Proxy $proxy) use($entityPersister, $classMetadata) { if ($proxy->__isInitialized()) { return; } $proxy->__setInitialized(\true); $proxy->__setInitializer(null); $class = $entityPersister->getClassMetadata(); $identifier = $classMetadata->getIdentifierValues($proxy); $original = $entityPersister->loadById($identifier); if (null === $original) { throw \MailPoetVendor\Doctrine\ORM\EntityNotFoundException::fromClassNameAndIdentifier($classMetadata->getName(), $this->identifierFlattener->flattenIdentifier($classMetadata, $identifier)); } foreach ($class->getReflectionProperties() as $property) { if (!$class->hasField($property->name) && !$class->hasAssociation($property->name)) { continue; } $property->setAccessible(\true); $property->setValue($proxy, $property->getValue($original)); } }; } } 